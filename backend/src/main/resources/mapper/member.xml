<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="tayo.sseuktudy.mapper.MemberMapper">
    <insert id="applyStudy" parameterType="MemberJoinDto">
        insert into user_join_study (user_id, study_id, user_status, user_nickname, user_introduction)
        values(#{userId}, #{studyId}, #{userStatus},#{userNickname}, #{userIntroduction})
    </insert>

    <select id="getMembers" parameterType="int" resultType="MemberInfoDto">
        select ujs.user_id userId, ujs.study_id studyId, ujs.user_status userStatus, ujs.user_introduction userIntroduction, ujs.user_nickname userNickname, q.question_id questionId , q.question_content questionContent, uaq.question_answer questionAnswer
        from user_join_study ujs
                 right join question q
                            on ujs.study_id = q.study_id
                 right join user_answer_question uaq
                            on q.question_id = uaq.question_id
        where ujs.study_id = #{studyId}
        order by ujs.user_id, q.question_id;
    </select>

    <update id="acceptMember" parameterType="MemberStatusChangeDto">
        update user_join_study set user_status = "member"
        where user_id=#{userId} and study_id=#{studyId}
    </update>

    <delete id="refuseMember" parameterType="MemberStatusChangeDto">
        delete ujs, usq from user_join_study ujs inner join user_answer_question usq
               on ujs.user_id = usq.user_id and ujs.study_id = usq.study_id
               where ujs.user_id = #{userId} and ujs.study_id = #{studyId};
    </delete>

</mapper>